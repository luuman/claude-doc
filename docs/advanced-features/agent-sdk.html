<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-advanced-features/agent-sdk" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Claude Agent SDK | Claude Docs</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://luuman.github.io/claude-doc/docs/advanced-features/agent-sdk"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Claude Agent SDK | Claude Docs"><meta data-rh="true" name="description" content="将 Claude Code 的核心能力作为 SDK 调用，构建自定义 AI Agent 和自动化工作流"><meta data-rh="true" property="og:description" content="将 Claude Code 的核心能力作为 SDK 调用，构建自定义 AI Agent 和自动化工作流"><link data-rh="true" rel="icon" href="/claude-doc/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://luuman.github.io/claude-doc/docs/advanced-features/agent-sdk"><link data-rh="true" rel="alternate" href="https://luuman.github.io/claude-doc/docs/advanced-features/agent-sdk" hreflang="zh"><link data-rh="true" rel="alternate" href="https://luuman.github.io/claude-doc/docs/advanced-features/agent-sdk" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Claude Agent SDK","item":"https://luuman.github.io/claude-doc/docs/advanced-features/agent-sdk"}]}</script><link rel="alternate" type="application/rss+xml" href="/claude-doc/blog/rss.xml" title="Claude Docs RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/claude-doc/blog/atom.xml" title="Claude Docs Atom Feed"><link rel="stylesheet" href="/claude-doc/assets/css/styles.b961a2e4.css">
<script src="/claude-doc/assets/js/runtime~main.b2563310.js" defer="defer"></script>
<script src="/claude-doc/assets/js/main.906b66fd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"dark"),document.documentElement.setAttribute("data-theme-choice",t||"dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav class="navbar navbar--fixed-top navbar_MONK" role="navigation" aria-label="Main"><div class="navbarInner_ASTH"><div class="navbarLeft_pUmY"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="brand_SXL9" href="/claude-doc/"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="24" height="24" rx="6" fill="var(--ifm-color-primary)"></rect><path d="M7 8.5h10M7 12h7M7 15.5h10" stroke="white" stroke-width="1.8" stroke-linecap="round"></path></svg><span class="brandTitle_XbyU">Claude</span></a><div class="dropdown_GrgZ"><button class="dropdownToggle_Nf_z">全部站点<svg class="dropdownArrow_Eka8" viewBox="0 0 12 12" fill="none"><path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg></button><ul class="dropdownMenu_zsxH"><li><a href="https://luuman.github.io/docs-workspace/docs" class="dropdownMenuItem_VBaP">Workspace</a></li><li><a href="https://luuman.github.io/moltbot-doc/docs" class="dropdownMenuItem_VBaP">Moltbot</a></li><li><a href="https://luuman.github.io/electron-doc/docs" class="dropdownMenuItem_VBaP">Electron</a></li><li><a href="https://luuman.github.io/tauri-doc/docs" class="dropdownMenuItem_VBaP">Tauri</a></li><li><a href="https://luuman.github.io/matrx-doc/docs" class="dropdownMenuItem_VBaP">Matrx</a></li><li><a href="https://luuman.github.io/brainboard-doc/docs" class="dropdownMenuItem_VBaP">Brainboard</a></li><li><a href="https://luuman.github.io/synology-doc/docs" class="dropdownMenuItem_VBaP">Synology</a></li><li><a href="https://luuman.github.io/codex-doc/docs" class="dropdownMenuItem_VBaP">Codex</a></li><li><a href="https://luuman.github.io/ai-doc/docs" class="dropdownMenuItem_VBaP">AI</a></li></ul></div></div><div class="navbarCenter_Zdr3"><div class="root_OF3s"><span class="icon_UcOK" aria-hidden="true"><svg viewBox="0 0 24 24" fill="currentColor" width="15" height="15"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg></span><div class="slot__FGx"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="搜索" aria-label="Search" class="navbar__search-input searchInput_YFbd" value=""><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div class="navbarRight_q16u"><a class="navLink_RnnM" href="/claude-doc/docs">Docs</a><a class="navLink_RnnM" href="/claude-doc/blog">Blog</a><button class="themeToggle_zD_x" aria-label="Switch to light theme" title="Light"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button></div></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/claude-doc/docs"><span title="Claude Code 完全指南" class="linkLabel_WmDU">Claude Code 完全指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/claude-doc/docs/getting-started"><span title="快速开始" class="linkLabel_WmDU">快速开始</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/claude-doc/docs/core-concepts/skills"><span title="核心概念" class="categoryLinkLabel_W154">核心概念</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/skills"><span title="Skills（技能包）" class="linkLabel_WmDU">Skills（技能包）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/hooks"><span title="Hooks（钩子）" class="linkLabel_WmDU">Hooks（钩子）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/plugins"><span title="Plugins（插件）" class="linkLabel_WmDU">Plugins（插件）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/mcp-servers"><span title="MCP Servers（模型上下文协议）" class="linkLabel_WmDU">MCP Servers（模型上下文协议）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/subagents"><span title="Subagents（子代理）" class="linkLabel_WmDU">Subagents（子代理）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/claude-md"><span title="CLAUDE.md（项目记忆文件）" class="linkLabel_WmDU">CLAUDE.md（项目记忆文件）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/core-concepts/memory"><span title="Memory（自动记忆）" class="linkLabel_WmDU">Memory（自动记忆）</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/claude-doc/docs/advanced-features/plan-mode"><span title="高级功能" class="categoryLinkLabel_W154">高级功能</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/advanced-features/plan-mode"><span title="Plan 模式（规划模式）" class="linkLabel_WmDU">Plan 模式（规划模式）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/advanced-features/headless-mode"><span title="Headless 模式（无头模式）" class="linkLabel_WmDU">Headless 模式（无头模式）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/advanced-features/slash-commands"><span title="自定义斜杠命令" class="linkLabel_WmDU">自定义斜杠命令</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/claude-doc/docs/advanced-features/agent-sdk"><span title="Claude Agent SDK" class="linkLabel_WmDU">Claude Agent SDK</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/advanced-features/ide-integration"><span title="IDE 集成" class="linkLabel_WmDU">IDE 集成</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/advanced-features/vibecraft"><span title="VibeCraft — Claude Code 3D 可视化" class="linkLabel_WmDU">VibeCraft — Claude Code 3D 可视化</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/claude-doc/docs/best-practices/workflow"><span title="最佳实践" class="categoryLinkLabel_W154">最佳实践</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/best-practices/workflow"><span title="工作流最佳实践" class="linkLabel_WmDU">工作流最佳实践</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/best-practices/performance"><span title="性能优化" class="linkLabel_WmDU">性能优化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/best-practices/security"><span title="安全与故障排查" class="linkLabel_WmDU">安全与故障排查</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist" href="/claude-doc/docs/category/真实场景案例库"><span title="真实场景案例库" class="categoryLinkLabel_W154">真实场景案例库</span></a><button aria-label="折叠侧边栏分类 &#x27;真实场景案例库&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases"><span title="真实场景案例库" class="linkLabel_WmDU">真实场景案例库</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/frontend-acceleration"><span title="React 项目加速" class="linkLabel_WmDU">React 项目加速</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/ui-components"><span title="UI 组件库自动化" class="linkLabel_WmDU">UI 组件库自动化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/backend-api"><span title="API 快速开发" class="linkLabel_WmDU">API 快速开发</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/database-migration"><span title="数据库迁移和优化" class="linkLabel_WmDU">数据库迁移和优化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/cicd-automation"><span title="CI/CD 流程自动化" class="linkLabel_WmDU">CI/CD 流程自动化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/infrastructure-as-code"><span title="基础设施即代码（IaC）" class="linkLabel_WmDU">基础设施即代码（IaC）</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/api-documentation"><span title="API 文档自动化" class="linkLabel_WmDU">API 文档自动化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/technical-writing"><span title="技术文档写作" class="linkLabel_WmDU">技术文档写作</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/code-review"><span title="代码审查自动化" class="linkLabel_WmDU">代码审查自动化</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/claude-doc/docs/use-cases/knowledge-base"><span title="知识库维护" class="linkLabel_WmDU">知识库维护</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/claude-doc/docs/quick-reference"><span title="速查手册" class="linkLabel_WmDU">速查手册</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/claude-doc/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">高级功能</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Claude Agent SDK</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Claude Agent SDK</h1></header>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>什么是 Agent SDK</div><div class="admonitionContent_BuS1"><p>Claude Agent SDK 将 Claude Code 的底层核心能力——<strong>Agent Loop</strong>、<strong>工具管理</strong>、<strong>上下文管理</strong>——开放为可编程的 SDK 接口。开发者不再需要从零实现 AI Agent 的基础设施，而是直接在这些能力之上构建业务逻辑。</p></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="核心概念">核心概念<a href="#核心概念" class="hash-link" aria-label="核心概念的直接链接" title="核心概念的直接链接" translate="no">​</a></h2>
<p>Claude Agent SDK 的架构由三个核心层次组成：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token plain">┌────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">│              你的业务逻辑（Custom Agent）         │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">├────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">│   Agent Loop   │   工具管理   │   上下文管理     │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">├────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">│              Claude API（底层模型）               │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">└────────────────────────────────────────────────┘</span><br></span></code></pre></div></div>
<p><strong>Agent Loop（智能体循环）</strong>
Claude 的核心执行引擎，驱动&quot;思考 → 工具调用 → 观察 → 迭代&quot;的循环，直到任务完成。</p>
<p><strong>工具管理（Tool Management）</strong>
定义 Agent 能够使用哪些工具（文件读写、Shell 命令、HTTP 请求等），SDK 负责工具调用的编排和结果处理。</p>
<p><strong>上下文管理（Context Management）</strong>
自动管理对话历史、压缩超长上下文、优先级排序，确保 Agent 始终在有效的上下文窗口内工作。</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="核心能力代码示例">核心能力代码示例<a href="#核心能力代码示例" class="hash-link" aria-label="核心能力代码示例的直接链接" title="核心能力代码示例的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="基础-agent-创建">基础 Agent 创建<a href="#基础-agent-创建" class="hash-link" aria-label="基础 Agent 创建的直接链接" title="基础 Agent 创建的直接链接" translate="no">​</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockTitle_OeMC">src/agent-basic.ts</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> Agent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Tool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Context </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;@anthropic-ai/claude-code-sdk&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 定义工具：文件读取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> readFileTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;read_file&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;读取指定路径的文件内容&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      path</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;文件路径（相对或绝对路径）&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      encoding</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">enum</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;base64&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;path&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> encoding </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> fs </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;fs/promises&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> content </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">readFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> encoding </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> BufferEncoding</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> size</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">length </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 定义工具：Shell 命令执行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> shellTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;run_command&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;执行 Shell 命令并返回输出&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      command</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;要执行的命令&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      cwd</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;工作目录（可选）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;command&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> command</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> cwd </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> process</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">cwd</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stderr </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">command</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> cwd </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stderr</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> exitCode</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">error</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">any</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stdout</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stderr</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> exitCode</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 创建上下文配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> context </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Context</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  maxSize</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">100_000</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 最大 token 数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  compression</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;auto&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">     </span><span class="token comment" style="color:#637777;font-style:italic">// 自动压缩策略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  priority</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;recent&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">      </span><span class="token comment" style="color:#637777;font-style:italic">// 优先保留最近内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  systemPrompt</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">你是一个专业的代码分析助手。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">你的目标是帮助开发者理解和改进代码质量。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">始终提供具体、可操作的建议。</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 创建并运行基础 Agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> agent </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  model</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;claude-opus-4-5&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  tools</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">readFileTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> shellTool</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  context</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  maxIterations</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">10</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onThink</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">thought</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;思考中:&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> thought</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">100</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">+</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;...&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onToolUse</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">tool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> input</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">工具调用: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">tool</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">(</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation constant" style="color:#F78C6C">JSON</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation function" style="color:#82AAFF">stringify</span><span class="token template-string interpolation punctuation" style="color:#C792EA">(</span><span class="token template-string interpolation">input</span><span class="token template-string interpolation punctuation" style="color:#C792EA">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">)</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onError</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">error</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;错误:&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onComplete</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;完成:&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">summary</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> result </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> agent</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">run</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;分析 src/ 目录的整体代码质量&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="案例-1自动化测试生成器">案例 1：自动化测试生成器<a href="#案例-1自动化测试生成器" class="hash-link" aria-label="案例 1：自动化测试生成器的直接链接" title="案例 1：自动化测试生成器的直接链接" translate="no">​</a></h2>
<p>将测试生成能力封装为可复用的 Agent，自动为任意源文件生成对应的测试用例。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockTitle_OeMC">src/agents/test-generator.ts</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> Agent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Tool </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;@anthropic-ai/claude-code-sdk&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> fs </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;fs/promises&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> path </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;path&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">class</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">TestGenerator</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">private</span><span class="token plain"> sourceDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">private</span><span class="token plain"> testDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">private</span><span class="token plain"> framework</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;vitest&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;mocha&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function" style="color:#82AAFF">constructor</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">options</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    sourceDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    testDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    framework</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;vitest&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;mocha&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> readSourceTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;read_source&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;读取源代码文件，返回内容和元信息&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          filePath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;源文件路径&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;filePath&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> filePath </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> filePath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> absolutePath </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">resolve</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">sourceDir</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> filePath</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> content </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">readFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">absolutePath</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> stats </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">stat</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">absolutePath</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 提取函数和类的签名（辅助 Claude 理解结构）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> functionMatches </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">match</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(?:</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">export</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">?</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(?:</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">async</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">?</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">function</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\w</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-flags" style="color:#D6DEEB">g</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> classMatches </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">match</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(?:</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">export</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">?</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">class</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\w</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-flags" style="color:#D6DEEB">g</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          content</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          filePath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> absolutePath</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          size</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> stats</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          functions</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> functionMatches</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          classes</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> classMatches</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          lines</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">split</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">length</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> writeTestTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;write_test&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;将生成的测试代码写入对应的测试文件&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          sourcePath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;对应的源文件路径&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          testContent</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;测试代码内容&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          overwrite</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;boolean&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;是否覆盖已有测试文件&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;sourcePath&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;testContent&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> sourcePath</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> testContent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> overwrite </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 生成测试文件路径（src/utils/parser.ts → tests/utils/parser.test.ts）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> relative </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">relative</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">sourceDir</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> sourcePath</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> testPath </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">join</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">testDir</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          relative</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">replace</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex special-escape escape" style="color:#D6DEEB">\.</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">ts</span><span class="token regex regex-source language-regex alternation keyword" style="color:#C792EA">|</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">js</span><span class="token regex regex-source language-regex alternation keyword" style="color:#C792EA">|</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">tsx</span><span class="token regex regex-source language-regex alternation keyword" style="color:#C792EA">|</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">jsx</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex anchor function" style="color:#82AAFF">$</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;.test.$1&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 检查文件是否已存在</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> exists </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">access</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">testPath</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">then</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">catch</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exists </span><span class="token operator" style="color:#7FDBCA">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">overwrite</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> reason</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;测试文件已存在，设置 overwrite=true 覆盖&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 确保目录存在</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">mkdir</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">dirname</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">testPath</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> recursive</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">writeFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">testPath</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> testContent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> testPath</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> linesWritten</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> testContent</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">split</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">length </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> runTestsTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;run_tests&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;运行指定的测试文件并返回结果&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          testFile</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;测试文件路径（可选，不指定则运行全部）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> testFile </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> testFile</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> framework </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">framework </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> cmd </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> testFile</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">npx </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">framework</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">testFile</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> --no-coverage</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">npx </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">framework</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> --no-coverage</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> stderr </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            cwd</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">cwd</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            timeout</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">60_000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> passed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> output</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> errors</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> stderr </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">error</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">any</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> passed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> output</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">stdout </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> errors</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">stderr </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">super</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      model</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;claude-opus-4-5&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      tools</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">readSourceTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> writeTestTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> runTestsTool</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      maxIterations</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">20</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      systemPrompt</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">你是一个专业的测试工程师，擅长为 TypeScript/JavaScript 代码编写高质量的单元测试。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">使用 </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">options</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">framework </span><span class="token template-string interpolation operator" style="color:#7FDBCA">||</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> 测试框架。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">测试要求：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">1. 测试覆盖正常路径、边界情况和异常情况</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">2. 使用描述性的测试名称（describe/it/test 块）</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">3. Mock 外部依赖（HTTP 请求、文件 I/O、数据库）</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">4. 每个函数至少 3 个测试用例</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">5. 生成测试后运行验证，修复失败的测试</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">sourceDir </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">sourceDir</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">testDir </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">testDir</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">framework </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> options</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">framework </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">generateForFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">filePath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">Promise</span><span class="token operator" style="color:#7FDBCA">&lt;</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> testPath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"> coverage</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token operator" style="color:#7FDBCA">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> result </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">run</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">为文件 </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">filePath</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> 生成完整的测试套件。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      步骤：1) 读取源文件  2) 分析所有导出  3) 生成测试代码  4) 写入测试文件  5) 运行测试确认通过</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      testPath</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">metadata</span><span class="token operator" style="color:#7FDBCA">?.</span><span class="token plain">testPath </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      coverage</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">metadata</span><span class="token operator" style="color:#7FDBCA">?.</span><span class="token plain">coverage </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 使用示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> generator </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">TestGenerator</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  sourceDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;./src&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  testDir</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;./tests&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  framework</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;jest&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> generator</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">generateForFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;utils/parser.ts&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> generator</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">generateForFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;services/auth.ts&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="案例-2代码审查机器人">案例 2：代码审查机器人<a href="#案例-2代码审查机器人" class="hash-link" aria-label="案例 2：代码审查机器人的直接链接" title="案例 2：代码审查机器人的直接链接" translate="no">​</a></h2>
<p>自动进行代码审查，输出结构化的审查报告，可集成到 CI/CD 流水线。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockTitle_OeMC">src/agents/code-reviewer.ts</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> Agent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Tool </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;@anthropic-ai/claude-code-sdk&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> fs </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;fs/promises&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">ReviewReport</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  overall</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;approve&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;request_changes&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;comment&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  score</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain">           </span><span class="token comment" style="color:#637777;font-style:italic">// 1-10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  summary</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  issues</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> ReviewIssue</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  suggestions</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  positives</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">ReviewIssue</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  severity</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;critical&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;major&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;minor&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;info&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  file</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  line</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  message</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  suggestion</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">class</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">CodeReviewer</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function" style="color:#82AAFF">constructor</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> readFileTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;read_file&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;读取指定文件的内容&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          path</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          startLine</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;number&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;开始行（可选）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          endLine</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;number&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;结束行（可选）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;path&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> path</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> startLine</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> endLine </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        path</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        startLine</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        endLine</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> content </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> fs</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">readFile</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">path</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;utf-8&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">startLine </span><span class="token operator" style="color:#7FDBCA">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">undefined</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">&amp;&amp;</span><span class="token plain"> endLine </span><span class="token operator" style="color:#7FDBCA">!==</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">undefined</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> lines </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">split</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> lines</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">startLine </span><span class="token operator" style="color:#7FDBCA">-</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">1</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> endLine</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">join</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> content</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> gitDiffTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;git_diff&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;获取 Git 差异，支持比较分支或提交&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          base</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;基础分支或提交（默认: main）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          head</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;目标分支或提交（默认: HEAD）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          file</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;仅显示特定文件的差异（可选）&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> base </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;main&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> head </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;HEAD&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> file </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        base</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        head</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        file</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> fileArg </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> file </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">-- </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">file</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">git diff </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">base</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">...</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">head</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">fileArg</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> maxBuffer</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">10</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">1024</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">1024</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">super</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      model</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;claude-opus-4-5&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      tools</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">readFileTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> gitDiffTool</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      maxIterations</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">15</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      systemPrompt</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">你是一位资深软件工程师，负责进行严格但建设性的代码审查。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">审查重点：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">1. 正确性：逻辑错误、边界条件、竞态条件</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">2. 安全性：SQL 注入、XSS、不安全的反序列化、硬编码密钥</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">3. 性能：N+1 查询、不必要的计算、内存泄露</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">4. 可维护性：命名规范、函数职责单一、重复代码</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">5. 测试覆盖：是否有对应的测试</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">输出格式要求：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">- 输出合法的 JSON，匹配 ReviewReport 接口</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">- severity 分级：critical（必须修复）/ major（强烈建议）/ minor（建议）/ info（仅供参考）</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">- overall：只有无 critical/major 问题时才选 approve</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">reviewPR</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">baseBranch</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> headBranch</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">Promise</span><span class="token operator" style="color:#7FDBCA">&lt;</span><span class="token plain">ReviewReport</span><span class="token operator" style="color:#7FDBCA">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> result </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">run</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">对以下 PR 进行全面代码审查：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      - 基础分支：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">baseBranch</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      - 目标分支：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">headBranch</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      步骤：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      1. 获取完整 diff</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      2. 对每个变更文件进行深度分析</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      3. 重点检查安全性和逻辑正确性</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">      4. 输出符合 ReviewReport 格式的 JSON 审查报告</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token comment" style="color:#637777;font-style:italic">// 从输出中提取 JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> jsonMatch </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">match</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex special-escape escape" style="color:#D6DEEB">\{</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#C792EA">[</span><span class="token regex regex-source language-regex char-class char-set class-name" style="color:#82AAFF">\s</span><span class="token regex regex-source language-regex char-class char-set class-name" style="color:#82AAFF">\S</span><span class="token regex regex-source language-regex char-class char-class-punctuation punctuation" style="color:#C792EA">]</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">*</span><span class="token regex regex-source language-regex special-escape escape" style="color:#D6DEEB">\}</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">jsonMatch</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Error</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;无法提取 JSON 报告&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token constant" style="color:#F78C6C">JSON</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">parse</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">jsonMatch</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> ReviewReport</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token comment" style="color:#637777;font-style:italic">// 降级处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        overall</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;comment&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        score</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">5</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        summary</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        issues</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        suggestions</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        positives</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function" style="color:#82AAFF">formatReport</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">report</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> ReviewReport</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> icons </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> critical</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;🔴&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> major</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;🟠&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> minor</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;🟡&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> info</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;🔵&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> overall </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> approve</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;✅ 批准&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> request_changes</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;❌ 需要修改&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> comment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;💬 已评论&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">let</span><span class="token plain"> output </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D"># 代码审查报告\n\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">**结论：** </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">overall</span><span class="token template-string interpolation punctuation" style="color:#C792EA">[</span><span class="token template-string interpolation">report</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">overall</span><span class="token template-string interpolation punctuation" style="color:#C792EA">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">**质量评分：** </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">report</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">score</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">/10\n\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">## 总体评价\n</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">report</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">summary</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\n\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">report</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">issues</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">length </span><span class="token operator" style="color:#7FDBCA">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">## 发现的问题\n\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token keyword" style="color:#C792EA">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> issue </span><span class="token keyword" style="color:#C792EA">of</span><span class="token plain"> report</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">issues</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> loc </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> issue</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">line </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">file</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">line</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> issue</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">file</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">icons</span><span class="token template-string interpolation punctuation" style="color:#C792EA">[</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">severity</span><span class="token template-string interpolation punctuation" style="color:#C792EA">]</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> **[</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">severity</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation function" style="color:#82AAFF">toUpperCase</span><span class="token template-string interpolation punctuation" style="color:#C792EA">(</span><span class="token template-string interpolation punctuation" style="color:#C792EA">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">]** \`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">loc</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\`\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">  </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">issue</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">suggestion</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">  &gt; 建议：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">issue</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">suggestion</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;\n&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">report</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">positives</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">length </span><span class="token operator" style="color:#7FDBCA">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">## 值得肯定\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      report</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">positives</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">forEach</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">p </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> output </span><span class="token operator" style="color:#7FDBCA">+=</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">- </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">p</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">\n</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> output</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 使用示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> reviewer </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">CodeReviewer</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> report </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> reviewer</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">reviewPR</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;main&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;feat/user-auth&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">reviewer</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">formatReport</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">report</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="案例-3自动化部署助手">案例 3：自动化部署助手<a href="#案例-3自动化部署助手" class="hash-link" aria-label="案例 3：自动化部署助手的直接链接" title="案例 3：自动化部署助手的直接链接" translate="no">​</a></h2>
<p>封装完整的部署流程，支持多环境部署、自动回滚和实时状态通知。</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockTitle_OeMC">src/agents/deployment-bot.ts</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> Agent</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Tool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> Context </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">from</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;@anthropic-ai/claude-code-sdk&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">type</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Environment</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;staging&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">|</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">interface</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">DeploymentResult</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">boolean</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  version</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  duration</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">number</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  rollbackTag</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">class</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">DeploymentBot</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">extends</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">private</span><span class="token plain"> environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">private</span><span class="token plain"> notificationWebhook</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function" style="color:#82AAFF">constructor</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> Environment</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> notificationWebhook</span><span class="token operator" style="color:#7FDBCA">?</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> runTestsTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;run_tests&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;运行测试套件，返回通过率和失败用例&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          suite</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            </span><span class="token keyword" style="color:#C792EA">enum</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;unit&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;integration&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;e2e&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;all&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;all&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> suite </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;all&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> cmd </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> suite </span><span class="token operator" style="color:#7FDBCA">===</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;all&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;npm run test:ci&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">npm run test:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">suite</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> timeout</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">300_000</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> passMatch </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">match</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex" style="color:#D6DEEB"> passed</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> failMatch </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">match</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">(</span><span class="token regex regex-source language-regex char-set class-name" style="color:#82AAFF">\d</span><span class="token regex regex-source language-regex quantifier number" style="color:#F78C6C">+</span><span class="token regex regex-source language-regex group punctuation" style="color:#C792EA">)</span><span class="token regex regex-source language-regex" style="color:#D6DEEB"> failed</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            passed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">failMatch</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            totalPassed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">parseInt</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">passMatch</span><span class="token operator" style="color:#7FDBCA">?.</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token number" style="color:#F78C6C">1</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;0&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            totalFailed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">parseInt</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">failMatch</span><span class="token operator" style="color:#7FDBCA">?.</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token number" style="color:#F78C6C">1</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">||</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;0&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            output</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token operator" style="color:#7FDBCA">-</span><span class="token number" style="color:#F78C6C">2000</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain">  </span><span class="token comment" style="color:#637777;font-style:italic">// 最后 2000 字符</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">error</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">any</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> passed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> error</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> buildTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;build&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;构建生产包，返回构建产物信息&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          env</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">enum</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;staging&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;env&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> env </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> start </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">now</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">NODE_ENV=</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">env</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> npm run build</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> duration </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">now</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">-</span><span class="token plain"> start</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> du </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;du -sh dist/&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> size</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> du</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">split</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;\t&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> duration </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> deployTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;deploy&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;将构建产物部署到指定环境&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">enum</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;staging&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          dryRun</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;boolean&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;演习模式（不实际部署）&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;environment&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> dryRun </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">dryRun</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> dryRun</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> message</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;演习模式：部署命令验证通过&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">npm run deploy:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">environment</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> deployedAt</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Date</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">toISOString</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> verifyTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;verify&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;验证部署后的服务健康状态&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          checks</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;array&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            items</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;要检查的端点列表&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;environment&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> checks </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;/health&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;/api/status&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> baseUrl </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> environment </span><span class="token operator" style="color:#7FDBCA">===</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> process</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token constant" style="color:#F78C6C">PROD_URL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token constant" style="color:#F78C6C">STAGING_URL</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> results </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">Promise</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">all</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          checks</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">map</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">endpoint</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            </span><span class="token keyword" style="color:#C792EA">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">              </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> fetch </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;node-fetch&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">              </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> res </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">fetch</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">baseUrl</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">endpoint</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> timeout</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">10_000</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">as</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">any</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">              </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> status</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> res</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">status</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> ok</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> res</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">ok </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">catch</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">err</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">any</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">              </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> endpoint</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> status</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> ok</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> error</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> err</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">            </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          allPassed</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> results</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">every</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">r </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> r</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">ok</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          results</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> rollbackTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;rollback&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;回滚到指定版本&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          tag</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;Git tag 或部署 ID&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;tag&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;environment&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> tag</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> environment </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> exec </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;child_process&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> promisify </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;util&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> execAsync </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">promisify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">exec</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">git checkout </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">tag</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">npm run deploy:</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">environment</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> rolledBackTo</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> tag</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> environment </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> notifyTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      name</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;notify&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      description</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;发送部署状态通知到 Slack/飞书&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      parameters</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        properties</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          status</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">enum</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;started&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;success&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;failure&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;rollback&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          message</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;string&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          details</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> type</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;object&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        required</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token string" style="color:#ECC48D">&#x27;status&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;message&#x27;</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> status</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> details </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">notificationWebhook</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> sent</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">false</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> reason</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;未配置 webhook&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> emoji </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> started</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;🚀&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;✅&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> failure</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;❌&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> rollback</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;↩️&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">status</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> payload </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          text</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">emoji</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> *部署通知*: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">message</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          attachments</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> details </span><span class="token operator" style="color:#7FDBCA">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> text</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token constant" style="color:#F78C6C">JSON</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">stringify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">details</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">null</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">2</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">default</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> fetch </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">import</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;node-fetch&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">fetch</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">notificationWebhook</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          method</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          headers</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> </span><span class="token string-property property" style="color:#F78C6C">&#x27;Content-Type&#x27;</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;application/json&#x27;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">          body</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token constant" style="color:#F78C6C">JSON</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">stringify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">        </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> sent</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token boolean" style="color:#F78C6C">true</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> context </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Context</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      maxSize</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">80_000</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      compression</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;auto&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      priority</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;recent&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      systemPrompt</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">你是一个专业的 DevOps 助手，负责安全、可靠地执行部署流程。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">部署原则：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">1. 安全第一：测试未通过绝不部署</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">2. 谨慎操作：生产部署前必须在 Staging 验证</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">3. 留有后路：部署前创建回滚点</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">4. 及时通知：每个关键节点通知团队</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">5. 快速响应：发现问题立即触发回滚</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">super</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      model</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;claude-opus-4-5&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      tools</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">runTestsTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> buildTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> deployTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> verifyTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> rollbackTool</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> notifyTool</span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      context</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      maxIterations</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">environment </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> environment</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">notificationWebhook </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> notificationWebhook</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">deploy</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">version</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">string</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token builtin" style="color:#ADDB67">Promise</span><span class="token operator" style="color:#7FDBCA">&lt;</span><span class="token plain">DeploymentResult</span><span class="token operator" style="color:#7FDBCA">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> startTime </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">now</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> result </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">run</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">执行 </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation keyword" style="color:#C792EA">this</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">environment</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> 环境部署，版本：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">version</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">部署流程：</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">1. 发送&quot;部署开始&quot;通知</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">2. 运行完整测试套件（unit + integration）</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">3. 如测试通过：构建 </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation keyword" style="color:#C792EA">this</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">environment</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> 包</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">4. </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation keyword" style="color:#C792EA">this</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">environment </span><span class="token template-string interpolation operator" style="color:#7FDBCA">===</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#7FDBCA">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;先部署 staging 验证，再部署 production&#x27;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#7FDBCA">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;部署到 staging&#x27;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">5. 验证部署后健康状态</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">6. 发送&quot;部署成功/失败&quot;通知</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">7. 如失败：执行回滚并通知</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="display:inline-block;color:#ECC48D"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">关键约束：任何步骤失败都必须停止并回滚，不允许带着问题继续。</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token template-string string" style="color:#ECC48D">    </span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      success</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">includes</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;失败&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">!</span><span class="token plain">result</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">includes</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;回滚&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      environment</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">this</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">environment</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      version</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">      duration</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> Date</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">now</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">-</span><span class="token plain"> startTime</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 使用示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> bot </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">DeploymentBot</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;production&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> process</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">env</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token constant" style="color:#F78C6C">SLACK_WEBHOOK</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> result </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> bot</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">deploy</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token string" style="color:#ECC48D">&#x27;v2.3.1&#x27;</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">部署</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">success </span><span class="token template-string interpolation operator" style="color:#7FDBCA">?</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;成功&#x27;</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation operator" style="color:#7FDBCA">:</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation string" style="color:#ECC48D">&#x27;失败&#x27;</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">耗时：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation punctuation" style="color:#C792EA">(</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">duration </span><span class="token template-string interpolation operator" style="color:#7FDBCA">/</span><span class="token template-string interpolation"> </span><span class="token template-string interpolation number" style="color:#F78C6C">1000</span><span class="token template-string interpolation punctuation" style="color:#C792EA">)</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation function" style="color:#82AAFF">toFixed</span><span class="token template-string interpolation punctuation" style="color:#C792EA">(</span><span class="token template-string interpolation number" style="color:#F78C6C">1</span><span class="token template-string interpolation punctuation" style="color:#C792EA">)</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">s</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="核心优势">核心优势<a href="#核心优势" class="hash-link" aria-label="核心优势的直接链接" title="核心优势的直接链接" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-完整的-agent-loop">1. 完整的 Agent Loop<a href="#1-完整的-agent-loop" class="hash-link" aria-label="1. 完整的 Agent Loop的直接链接" title="1. 完整的 Agent Loop的直接链接" translate="no">​</a></h3>
<p>Agent SDK 内置了经过生产验证的执行引擎：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    │         任务输入             │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    └─────────────┬───────────────┘</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                                  ↓</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             ┌─── │   Thinking（深度思考）        │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │    └─────────────┬───────────────┘</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │                  ↓</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │    │   Tool Use（工具调用）        │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │    └─────────────┬───────────────┘</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    循         │                  ↓</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    环         │    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    执         │    │   Observation（结果观察）     │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    行         │    └─────────────┬───────────────┘</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │                  ↓</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             │    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">             └─── │   Iteration（决策下一步）     │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                  └─────────────┬───────────────┘</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                                  ↓ 任务完成</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    ┌─────────────────────────────┐</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    │         结果输出             │</span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">                    └─────────────────────────────┘</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-强大的上下文管理">2. 强大的上下文管理<a href="#2-强大的上下文管理" class="hash-link" aria-label="2. 强大的上下文管理的直接链接" title="2. 强大的上下文管理的直接链接" translate="no">​</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> context </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Context</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  maxSize</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">100_000</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">          </span><span class="token comment" style="color:#637777;font-style:italic">// 最大 100K token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  compression</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;auto&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">       </span><span class="token comment" style="color:#637777;font-style:italic">// 自动压缩策略</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  priority</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token string" style="color:#ECC48D">&#x27;recent&#x27;</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 优先保留最近内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  preservePatterns</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">[</span><span class="token plain">        </span><span class="token comment" style="color:#637777;font-style:italic">// 永远保留的内容模式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token operator" style="color:#7FDBCA">/</span><span class="token constant" style="color:#F78C6C">ERROR</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token operator" style="color:#7FDBCA">/</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">CRITICAL:</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token regex regex-source language-regex" style="color:#D6DEEB">## 部署计划</span><span class="token regex regex-delimiter" style="color:#D6DEEB">/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">]</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onCompress</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">before</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> after</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">上下文压缩：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">before</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> → </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">after</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D"> tokens</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-灵活的工具系统">3. 灵活的工具系统<a href="#3-灵活的工具系统" class="hash-link" aria-label="3. 灵活的工具系统的直接链接" title="3. 灵活的工具系统的直接链接" translate="no">​</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token comment" style="color:#637777;font-style:italic">// 工具可以是同步或异步</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> syncTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> x </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> x </span><span class="token operator" style="color:#7FDBCA">*</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 工具可以调用外部 API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> apiTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> endpoint </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> res </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">fetch</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">endpoint</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">json</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 工具可以执行 Shell 命令</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> shellTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> cmd </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> stdout </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">await</span><span class="token plain"> </span><span class="token function" style="color:#82AAFF">execAsync</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">cmd</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token keyword" style="color:#C792EA">return</span><span class="token plain"> stdout</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token comment" style="color:#637777;font-style:italic">// 工具可以是其他 Agent（Multi-Agent）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> subAgent </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">...</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> agentTool </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Tool</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">execute</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"> task </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> subAgent</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">run</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-完整的可观测性">4. 完整的可观测性<a href="#4-完整的可观测性" class="hash-link" aria-label="4. 完整的可观测性的直接链接" title="4. 完整的可观测性的直接链接" translate="no">​</a></h3>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D6DEEB;--prism-background-color:#001122"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="color:#D6DEEB;background-color:#001122"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D6DEEB"><span class="token keyword" style="color:#C792EA">const</span><span class="token plain"> agent </span><span class="token operator" style="color:#7FDBCA">=</span><span class="token plain"> </span><span class="token keyword" style="color:#C792EA">new</span><span class="token plain"> </span><span class="token class-name" style="color:#82AAFF">Agent</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onThink</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">thought</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> iteration</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">[迭代 </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">iteration</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">] 思考:</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> thought</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">200</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onToolUse</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">toolName</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> input</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> output</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">工具: </span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">toolName</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">输入:</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token constant" style="color:#F78C6C">JSON</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">stringify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">input</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">100</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">输出:</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token constant" style="color:#F78C6C">JSON</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">stringify</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">output</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">slice</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token number" style="color:#F78C6C">0</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> </span><span class="token number" style="color:#F78C6C">100</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onError</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">error</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">error</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">错误 [</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">context</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">iteration</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">]:</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token plain">message</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token comment" style="color:#637777;font-style:italic">// 可以选择重试或降级处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token function-variable function" style="color:#82AAFF">onComplete</span><span class="token operator" style="color:#7FDBCA">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token plain"> </span><span class="token operator" style="color:#7FDBCA">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#C792EA">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">完成！</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">- 总迭代次数：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">iterations</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">- 工具调用次数：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">toolCalls</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">- Token 消耗：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">tokenUsage</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">    </span><span class="token builtin" style="color:#ADDB67">console</span><span class="token punctuation" style="color:#C792EA">.</span><span class="token function" style="color:#82AAFF">log</span><span class="token punctuation" style="color:#C792EA">(</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token template-string string" style="color:#ECC48D">- 耗时：</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">${</span><span class="token template-string interpolation">result</span><span class="token template-string interpolation punctuation" style="color:#C792EA">.</span><span class="token template-string interpolation">duration</span><span class="token template-string interpolation interpolation-punctuation punctuation" style="color:#C792EA">}</span><span class="token template-string string" style="color:#ECC48D">ms</span><span class="token template-string template-punctuation string" style="color:#ECC48D">`</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain">  </span><span class="token punctuation" style="color:#C792EA">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D6DEEB"><span class="token plain"></span><span class="token punctuation" style="color:#C792EA">}</span><span class="token punctuation" style="color:#C792EA">)</span><span class="token punctuation" style="color:#C792EA">;</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="使用场景">使用场景<a href="#使用场景" class="hash-link" aria-label="使用场景的直接链接" title="使用场景的直接链接" translate="no">​</a></h2>









































<table><thead><tr><th>场景</th><th>Agent 示例</th><th>主要工具</th><th>价值</th></tr></thead><tbody><tr><td><strong>CI/CD 集成</strong></td><td>代码审查机器人、部署助手</td><td>gitDiff、deploy、notify</td><td>自动化质量门禁，减少人工干预</td></tr><tr><td><strong>自动化运维</strong></td><td>监控告警处理、日志分析</td><td>readLogs、callAPI、runScript</td><td>7x24 小时无人值守响应</td></tr><tr><td><strong>文档生成</strong></td><td>API 文档生成器、变更日志生成</td><td>readSource、writeDoc、gitLog</td><td>文档与代码始终同步</td></tr><tr><td><strong>代码迁移</strong></td><td>框架升级助手、依赖迁移工具</td><td>readFile、writeFile、runTests</td><td>大规模代码变更的安全执行</td></tr><tr><td><strong>教学工具</strong></td><td>代码讲解助手、练习生成器</td><td>readFile、explainCode</td><td>个性化学习体验</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>注意事项</div><div class="admonitionContent_BuS1"><p>Agent SDK 目前处于早期访问阶段，API 可能发生变化。在生产环境使用前，建议锁定依赖版本并充分测试。</p><p>使用 <code>--dangerously-skip-permissions</code> 或 SDK 的 <code>skipPermissions: true</code> 时，请确保 Agent 运行在受控环境中，避免误操作生产数据。</p></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/claude-doc/docs/advanced-features/slash-commands"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">自定义斜杠命令</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/claude-doc/docs/advanced-features/ide-integration"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">IDE 集成</div></a></nav></div></div><div class="col col--3"><div class="tocWrapper_xKoj"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#核心概念" class="table-of-contents__link toc-highlight">核心概念</a></li><li><a href="#核心能力代码示例" class="table-of-contents__link toc-highlight">核心能力代码示例</a><ul><li><a href="#基础-agent-创建" class="table-of-contents__link toc-highlight">基础 Agent 创建</a></li></ul></li><li><a href="#案例-1自动化测试生成器" class="table-of-contents__link toc-highlight">案例 1：自动化测试生成器</a></li><li><a href="#案例-2代码审查机器人" class="table-of-contents__link toc-highlight">案例 2：代码审查机器人</a></li><li><a href="#案例-3自动化部署助手" class="table-of-contents__link toc-highlight">案例 3：自动化部署助手</a></li><li><a href="#核心优势" class="table-of-contents__link toc-highlight">核心优势</a><ul><li><a href="#1-完整的-agent-loop" class="table-of-contents__link toc-highlight">1. 完整的 Agent Loop</a></li><li><a href="#2-强大的上下文管理" class="table-of-contents__link toc-highlight">2. 强大的上下文管理</a></li><li><a href="#3-灵活的工具系统" class="table-of-contents__link toc-highlight">3. 灵活的工具系统</a></li><li><a href="#4-完整的可观测性" class="table-of-contents__link toc-highlight">4. 完整的可观测性</a></li></ul></li><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li></ul></div><div class="tocFooter_Fu2z"><div class="themeGroup_RzWV" role="group" aria-label="Theme"><button class="themeBtn_tGr6" aria-label="Light theme" title="Light"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"></path></svg></button><button class="themeBtn_tGr6 themeBtnActive_A6tm" aria-label="Dark theme" title="Dark"><svg viewBox="0 0 24 24" width="15" height="15" fill="currentColor" aria-hidden="true"><path d="M11.38 2.019a7.5 7.5 0 1 0 10.6 10.6C21.83 17.963 17.315 22 12.002 22 6.477 22 2 17.523 2 12c0-5.314 4.038-9.827 9.38-10.28z"></path></svg></button></div></div></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Claude Docs.</div></div></div></footer></div>
</body>
</html>